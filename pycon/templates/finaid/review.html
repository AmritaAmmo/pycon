{% extends "site_base.html" %}

{% load compress %}
{% load i18n %}

{% load bootstrap_tags %}
{% load account_tags %}

{% block body %}
  <h3>{% trans "Financial aid application:" %} {{ application.user }}</h3>

  <div class="tabbable">
    <ul class="nav nav-tabs">
      <li class="active"><a href="#application-detail" data-toggle="tab">{% trans "Application Details" %}</a></li>
      <li><a href="#application-messages" data-toggle="tab">{% trans "Messages" %} <span class="badge">{{ application.messages.all|length }}</span></a></li>
      <li><a href="#application-review" data-toggle="tab">{% trans "Review data" %}</a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active" id="application-detail">
        {% with is_reviewer=True %}
          {% include "finaid/_application_fields.html" %}
        {% endwith %}
      </div>
      <div class="tab-pane" id="application-messages">
        {% if review_messages %}
          <h3>{% trans "Messages" %}</h3>
          {% for message in review_messages %}
            <div class="comment-box{% if not message.visible %} private{% endif %}">
              <div class="commment-content">
                <b>{% user_display message.user %}</b>
                {{ message.submitted_at|timesince }} ago
                {% if not message.visible %}(private to reviewers){% endif %}
                <br />
                {{ message.message|safe }}
              </div>
            </div>
          {% endfor %}

        {% else %}
          {% trans "No messages" %}
        {% endif %}
        <hr />

        <h3>{% trans "Add a Message" %}</h3>
        {% with form=message_form %}
          {% if form.errors %}
            <div class="alert">
              <p class="text-error">
                {% trans "There were errors in your form, please correct them and submit again." %}
              </p>
            </div>
          {% endif %}
          <form action="" method="POST" accept-charset="utf-8">
            {% csrf_token %}
            <fieldset>
              {{ form|as_bootstrap }}
            </fieldset>
            <div class="actions">
              <button type="submit" name="message_submit" class="btn primary">{% trans "Submit" %}</button>
            </div>
          </form>
        {% endwith %}
      </div>
      <div class="tab-pane" id="application-review">
        Review data<br/>Not yet implemented.
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_script %}
  {% compress js %}
    <script src="{{ STATIC_URL }}symposion/js/jquery.history.js"></script>
    <script type="text/javascript">
      $(function() {
        var History = window.History;

        $(window).bind("anchorchange", function() {
          $(".nav-tabs a[href='" + location.hash + "']").click();
        });

        $('.nav-tabs a[data-toggle="tab"]').on('shown', function (e) {
          if (History.enabled) {
            History.pushState(null, null, $(e.target).attr("href"));
          }
        });
      });
    </script>
  {% endcompress %}
{% endblock %}
